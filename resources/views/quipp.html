<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

<table id="auth-menu">
    <tr>
        <td>
            Имя
        </td>
        <td>
            <input type="text" id="usernameinput">
        </td>
    </tr>
    <tr>
        <td rowspan="99">
            <button id="usernameinputsubmit" onclick="submit_username($('#usernameinput').val());">Отправить</button>
        </td>
    </tr>
</table>

<div id="wellcome-screen" hidden>

    <h1>Wellcomen, <span id="username-show"></span></h1>

    <table>
        <tr>
            <td>
                <button onclick="start_new_game();">Новая игра</button>
            </td>
            <td>
                <button onclick="join_game($('#roomname_input').val())">Подключиться</button><input type="text" id="roomname_input">
            </td>
        </tr>
    </table>

</div>

<div id="waiting" hidden>
    <h1>Wating...</h1>
</div>

<div id="lobby" hidden>

    <h1 id="lobby-name"></h1>

    <div id="ready-buttons">
        <button onclick="lobby_set_ready(1)" id="lobby-ready">Готов</button>
        <button onclick="lobby_set_ready(0)" hidden id="lobby-unready">Не готов</button>
    </div>

    <table id="lobby-players">
        <tr>
            <th>Игроки</th>
        </tr>
    </table>

</div>

<div id="question" hidden>
    <h1>Игра началась!</h1>

    <div id="objective-active" hidden>
        <h2>Придумайте забавный ответ на вопрос</h2>
    </div>
    <div id="objective-wait" hidden>
        <h2>Ожидание других игроков</h2>
    </div>

    <h3 id="question-view"></h3>

    <div id="answer-box">
        <input type="text" id="answer-inputtext">
        <button onclick="send_answer($('#answer-inputtext').val())">Отправить</button>
    </div>

    <div id="voting-prompt" hidden>
        <table id="voting-table">
        </table>

        <button onclick="send_vote($('.votecheck:checked').map(function(x) {return $(this).val();}).toArray());">Vote</button>

    </div>

</div>




</body>
</html>

<script>

    var key = null;
    var username = null;
    var userid = null;
    var currgamename = null;
    var currgameid = null;

    function auth_done(data) {

        $('#username-show').text(username);

        key = data.key;
        userid = data.id;

        $('#waiting').hide();
        $('#auth-menu').hide();
        $('#wellcome-screen').show();

    }

    function enter_lobby(data) {

        currgamename = data.name;
        currgameid = data.id;

        $('#lobby-name').text(data.name);


        $('#wellcome-screen').hide();
        $('#waiting').hide();
        $('#lobby').show();

        start_lobby_update();
        setInterval(start_lobby_update, 1000);

    }

    function update_lobby_data(data) {
        $("#lobby-players").find("tr:gt(0)").remove();

        //'started', 'answers', 'voting', 'showing_results', 'end'
        switch (data.game.status) {
            case 'started': {
                $('#ready-buttons').show();
                $('#question').hide();
                $('#voting-prompt').hide();
                $('#voting-table').empty();
                break;
            }
            case 'answers': {
                $('#ready-buttons').hide();
                $('#question').show();
                $('#voting-prompt').hide();
                $('#question-view').text(data.question.question);
                $('#voting-table').empty();
                break;
            }
            case 'voting': {
                $('#ready-buttons').hide();
                $('#question').show();
                $('#voting-prompt').show();
                $('#objective-wait').hide();

                if($('#voting-table').attr('game') != data.game.id || $('#voting-table').attr('round') != data.game.round) {

                    $('#voting-table').attr('game', data.game.id).attr('round', data.game.round);

                    for (var answerid in data.voting) {
                        $('#voting-table').append(`<tr><td><label><input class="votecheck" type="checkbox" value="${answerid}">${data.voting[answerid]}</label></td></tr>`);
                    }

                }





                break;
            }
        }

        $('#lobby').show();

        data.players.forEach(function (x) {
            if(x.ready === 'not ready') {
                if (x.userid === userid) {
                    $('#lobby-ready').show();
                    $('#lobby-unready').hide();
                }
                $("#lobby-players").append(`<tr><td style="color: red">${x.username}</td></tr>`);
            } else if(!x.answer_ready && data.game.started != null) {
                $("#lobby-players").append(`<tr><td style="color: #fff81c">${x.username}</td></tr>`);

                if (x.userid === userid) {
                    $('#answer-box').show();
                    $('#objective-active').show();
                    $('#objective-wait').hide();
                }

            } else {
                $("#lobby-players").append(`<tr><td style="color: green">${x.username}</td></tr>`);

                if (x.userid === userid) {
                    $('#lobby-ready').hide();
                    $('#lobby-unready').show();

                    if(data.game.started != null) {
                        $('#answer-box').hide();
                        $('#objective-active').hide();
                        $('#objective-wait').show();
                    }

                }


            }
        });


    }

    function start_lobby_update() {

        $.ajax({
            type: 'POST',
            url: '/quip/lobby',
            dataType: 'json',
            data: {key:key, game:currgameid},
            success: function(data){
                update_lobby_data(data);
            },
            fail: function(data) {
                console.log('error');
                console.log(data);
            }
        });

    }

    function send_vote(votes) {

        $.ajax({
            type: 'POST',
            url: '/quip/vote',
            dataType: 'json',
            data:  {key:key, game:currgameid, vote:votes},
            success: function(data){
                console.log(data);
            },
            fail: function(data) {
                console.log('error');
                console.log(data);
            }
        });

    }

    function submit_username(usrname) {

        username = usrname;

        $('#waiting').show();
        $('#auth-menu').hide();


        $.ajax({
            type: 'POST',
            url: '/quip/auth',
            dataType: 'json',
            data: {name:username},
            success: function(data){
                auth_done(data);

            },
            fail: function(data) {
                console.log('error');
                console.log(data);
            }
        });


    }

    function start_new_game() {

        $('#wellcome-screen').hide();
        $('#waiting').show();

        $.ajax({
            type: 'POST',
            url: '/quip/new',
            dataType: 'json',
            data: {key:key},
            success: function(data){
                enter_lobby(data);

            },
            fail: function(data) {
                console.log('error');
                console.log(data);
            }
        });

    }


    function join_game(gamename) {

        $('#wellcome-screen').hide();
        $('#waiting').show();

        $.ajax({
            type: 'POST',
            url: '/quip/join',
            dataType: 'json',
            data: {key:key, game:gamename},
            success: function(data){
                enter_lobby(data);

            },
            fail: function(data) {
                console.log('error');
                console.log(data);
            }
        });

    }


    function lobby_set_ready(status) {

        $.ajax({
            type: 'POST',
            url: '/quip/ready',
            dataType: 'json',
            data:  {key:key, game:currgameid, ready:status},
            success: function(data){
                update_lobby_data(data);
            },
            fail: function(data) {
                console.log('error');
                console.log(data);
            }
        });

    }

    function send_answer(answer) {

        $.ajax({
            type: 'POST',
            url: '/quip/answer',
            dataType: 'json',
            data:  {key:key, game:currgameid, answer:answer},
            success: function(data){
                update_lobby_data(data);
            },
            fail: function(data) {
                console.log('error');
                console.log(data);
            }
        });


    }


</script>
